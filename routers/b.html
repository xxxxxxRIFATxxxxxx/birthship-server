<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <div id="success-alert" class="alert alert-success;" style="display: none;">
        Thank you for your feedback.
    </div>

    <form method="post" id="feedback-form">
        <input type="number" id="rating" required>
        <input type="text" id="message" required>
        <input type="file" id="attachments" required multiple>
        <input type="submit" value="submit">
    </form>

    <script>
        const successAlert = document.getElementById("success-alert");
        const feedbackForm = document.getElementById("feedback-form");
        feedbackForm.addEventListener("submit", (event) => {
          event.preventDefault();
          const rating = document.getElementById("rating");
          const message = document.getElementById("message");
          const attachments = document.getElementById("attachments");
        
          const toBase64 = file => {
            return new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.readAsDataURL(file);
              reader.onload = () => resolve(reader.result);
              reader.onerror = error => reject(error);
            });
          };
        
         const tobase64Handler = async files => {
            const filePathsPromises = [];

            for (let i = 0; i < files.length; i++) {
                filePathsPromises.push(toBase64(files[i]));
            }

            const filePaths = await Promise.all(filePathsPromises);
            const mappedFiles = filePaths.map(base64File => base64File);
            return mappedFiles;
          };

          tobase64Handler(attachments.files)
            .then(data => {
                const feedback = JSON.stringify({
                    rating: rating.value,
                    message: message.value,
                    attachments: data
                });

                fetch('http://localhost:5000/feedback/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: feedback,
                })
                  .then((res) => {
                      if (res) {
                        rating.value = "";
                        message.value = "";
                        attachments.value = "";
                        successAlert.style.display = "block";
                        setTimeout(() => {
                            successAlert.style.display = "none";
                        }, 5000);
                      };
                  })
                  
            });
        });
    </script>
</body>
</html>